var w,h,font,fontData,glyphs=[],gIndex=0,glyphTable="deepressed",canvas,ctx;function preload(){fontData=loadBytes("SpaceMono-Regular.ttf")}function setup(){canvas=createCanvas(windowWidth,windowHeight,WEBGL);pixelDensity(1);w=width;h=height;noStroke();perspective(PI/3,width/height,.1,1E4);font=opentype.parse(fontData.bytes.buffer)}
function draw(){clear();translate(0,0,500);var a=constrain(map(rotationX,PI/2,-PI/2,.01*-PI,.01*PI),-PI/9,PI/9),c=constrain(map(rotationY,-PI/2,PI/2,.01*-PI,.01*PI),-PI/9,PI/9);rotateX(a);rotateY(c);for(a=0;30>a;a++)fill(250-10*a),tunnelUnit(300-200*a,200);for(a=0;a<glyphs.length;a++)c=glyphs[a],c.fall(-18),c.display(),-5E3>c.loc.z&&glyphs.splice(a,1)}
function mousePressed(){var a=glyphTable[int(gIndex++%glyphTable.length)];a=new Glyph(a,.6*(mouseX-width/2),.6*(mouseY-height/2),200);glyphs.push(a)}
var Glyph=function(a,c,b,f){this.fsize=.8*min(width,height);this.path=font.getPath(a,0,0,this.fsize);this.commands=this.path.commands;this.jamos=[];for(a=0;a<this.commands.length;a++){var d=this.commands[a];if("M"===d.type){var e=[];e.push(d)}else"L"===d.type?e.push(d):"C"===d.type?e.push(d):"Q"===d.type?e.push(d):"Z"===d.type&&(e.push(d),this.jamos.push(e))}this.loc=createVector(c,b,f);this.yRot=this.xRot=0;this.xRotInc=random(-.01,.01);this.yRotInc=random(-.01,.01)};
Glyph.prototype.showJamoAt=function(a){a=this.jamos[a];for(var c=0;c<a.length;c++){var b=a[c];"M"===b.type?(push(),beginShape(),vertex(b.x,b.y)):"L"===b.type?vertex(b.x,b.y):"C"===b.type?bezierVertex(b.x1,b.y1,b.x2,b.y2,b.x,b.y):"Q"===b.type?quadraticVertex(b.x1,b.y1,b.x,b.y):"Z"===b.type&&(endShape(CLOSE),pop())}};Glyph.prototype.fall=function(a){this.loc.z+=a;this.xRot+=this.xRotInc;this.yRot+=this.yRotInc};
Glyph.prototype.display=function(){push();translate(this.loc.x,this.loc.y,this.loc.z);rotateX(this.xRot);rotateY(this.yRot);fill(255+.05*this.loc.z,150+.05*this.loc.z,200+.05*this.loc.z);translate(-this.fsize/4,this.fsize/4,0);for(var a=0;a<this.jamos.length;a++)this.showJamoAt(a);pop()};
function tunnelUnit(a,c){push();translate(0,0,a);push();translate(-w/2,-h/2,0);rotateY(PI/2);rect(0,0,c,h);pop();push();translate(-w/2,-h/2,0);rotateX(-PI/2);rect(0,0,w,c);pop();push();translate(w/2,-h/2,0);rotateY(PI/2);rect(0,0,c,h);pop();push();translate(-w/2,h/2,0);rotateX(-PI/2);rect(0,0,w,c);pop();pop()};